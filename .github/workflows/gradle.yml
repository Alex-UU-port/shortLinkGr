
name: shortLink CI/CD

# Триггеры запуска pipeline
on:
  # Запуск при пуше в main
  push:
    branches: [ "main" ]

  # Запуск при pull request в main
  pull_request:
    branches: [ "main" ]

# Глобальные переменные окружения,
# доступны во всех job'ах
env:
  JAVA_VERSION: '17'          # Версия Java
  APP_NAME: shortLink             # Имя приложения
  JAR_NAME: shortLink.jar         # Итоговое имя jar-файла

jobs:

  # ============================================================
  # JOB 1: Сборка и тестирование (CI)
  # ============================================================
  build-and-test:
    # Имя job'а (видно в UI)
    name: Build & Test (${{ matrix.os }})

    # ОС будет определяться матрицей ниже
    runs-on: ${{ matrix.os }}

    # Стратегия запуска
    strategy:
      # false = не останавливать все сборки,
      # если одна из ОС упала
      fail-fast: false

      # Матрица ОС
      matrix:
        os:
          - ubuntu-latest
          - windows-latest

    steps:
      # ------------------------------
      # Шаг 1: Клонирование репозитория
      # ------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ------------------------------
      # Шаг 2: Установка Java 17
      # ------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'     # OpenJDK от Eclipse
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle               # Кэш зависимостей Gradle

      # --------------------------------------------------
      # Шаг 3: Права на gradlew (только для Linux)
      # --------------------------------------------------
      - name: Grant execute permission for Gradle wrapper
        if: runner.os == 'Linux'
        run: chmod +x gradlew

      # -----------------------------------------
      # Шаг 4: Сборка и запуск тестов
      # -----------------------------------------
      # Выполняет:
      #  - компиляцию
      #  - тесты
      #  - линты
      - name: Build and test project
        run: ./gradlew clean build

      # --------------------------------------------------
      # Шаг 5: Загрузка JAR как артефакта
      # --------------------------------------------------
      # Делаю это только на Linux,
      # чтобы не дублировать один и тот же jar
      - name: Upload JAR artifact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar

  # ============================================================
  # JOB 2: DEPLOY
  # ============================================================
  deploy:
    # Имя job'а
    name: Deploy to Windows Server

    # Job запустится ТОЛЬКО если build-and-test прошёл успешно
    needs: build-and-test

    # Запуск на self-hosted runner
    # runner должен иметь эти labels
    runs-on: [ self-hosted, windows, prod ]

    steps:
      # --------------------------------------------------
      # Шаг 1: Скачивание артефакта
      # --------------------------------------------------
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: artifact

      # --------------------------------------------------
      # Шаг 2: Остановка запущенного приложения
      # --------------------------------------------------

      - name: Stop application
        run: |
          echo "Stopping application..."
          powershell -Command "
            Get-Process java -ErrorAction SilentlyContinue |
            Stop-Process -Force
          "

      # --------------------------------------------------
      # Шаг 3: Копирование JAR в папку деплоя
      # --------------------------------------------------
      - name: Deploy JAR
        run: |
          echo "Deploying JAR..."

          # Создаём папку приложения, если её нет
          if (!(Test-Path 'C:\apps\${{ env.APP_NAME }}')) {
            New-Item -ItemType Directory -Path 'C:\apps\${{ env.APP_NAME }}'
          }

          # Копируем jar с заменой
          Copy-Item artifact\*.jar `
            C:\apps\${{ env.APP_NAME }}\${{ env.JAR_NAME }} `
            -Force

      # --------------------------------------------------
      # Шаг 4: Запуск приложения
      # --------------------------------------------------
      - name: Start application
        run: |
          echo "Starting application..."
          Start-Process java `
            -ArgumentList "-jar C:\apps\${{ env.APP_NAME }}\${{ env.JAR_NAME }}" `
            -WorkingDirectory "C:\apps\${{ env.APP_NAME }}" `
            -WindowStyle Hidden